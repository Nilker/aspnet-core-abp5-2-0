var FeaturesTree=function(e){return function(){function t(e){a.jstree("select_node",e,!0);var n=a.jstree("get_parent",e);n&&t(n)}var a;return{init:function(n){function i(){a.find(".jstree-node").each(function(){var t=e(this),a=t.find(".jstree-anchor"),n=JSON.parse(t.attr("data-feature")),i=t.attr("data-feature-value");if(n&&n.inputType)if("CHECKBOX"==n.inputType.name);else if("SINGLE_LINE_STRING"==n.inputType.name){if(!t.find(".feature-tree-textbox").length){a.find(".jstree-checkbox").hide();var r="text";n.inputType.validator&&"NUMERIC"==n.inputType.validator.name&&(r="number");var o=e('<input class="feature-tree-textbox" type="'+r+'" />').val(i);"number"==r?(o.attr("min",n.inputType.validator.minValue),o.attr("max",n.inputType.validator.maxValue)):n.inputType.validator&&"STRING"==n.inputType.validator.name&&(n.inputType.validator.maxLength>0&&o.attr("maxlength",n.inputType.validator.maxLength),n.inputType.validator.minLength>0&&o.attr("required","required"),n.inputType.validator.regularExpression&&o.attr("pattern",n.inputType.validator.regularExpression)),o.on("input propertychange paste",function(){!function(e,t){if(!e||!e.inputType||!e.inputType.validator)return!0;var a=e.inputType.validator;if("STRING"==a.name){if(void 0==t||null==t)return a.allowNull;if("string"!=typeof t)return!1;if(a.minLength>0&&t.length<a.minLength)return!1;if(a.maxLength>0&&t.length>a.maxLength)return!1;if(a.regularExpression)return new RegExp(a.regularExpression).test(t)}else if("NUMERIC"==a.name){var n=parseInt(t);if(isNaN(n))return!1;if(a.minValue>n)return!1;var i=a.maxValue;if(i>0&&n>i)return!1}return!0}(n,o.val())?o.addClass("feature-tree-textbox-invalid"):(t.attr("data-feature-value",o.val()),o.removeClass("feature-tree-textbox-invalid"))}),o.appendTo(t)}}else if("COMBOBOX"==n.inputType.name&&!t.find(".feature-tree-combobox").length){a.find(".jstree-checkbox").hide();var s=e('<select class="feature-tree-combobox" />');_.each(n.inputType.itemSource.items,function(t){e("<option></option>").attr("value",t.value).text(t.displayText).appendTo(s)}),s.val(i).on("change",function(){t.attr("data-feature-value",s.val())}).appendTo(t)}})}(a=n).on("ready.jstree",function(){i()}).on("redraw.jstree",function(){i()}).on("after_open.jstree",function(){i()}).on("create_node.jstree",function(){i()}).on("changed.jstree",function(n,i){if(i.node){var r;i.node.state.selected?(t(a.jstree("get_parent",i.node)),r=e.makeArray(a.jstree("get_children_dom",i.node)),a.jstree("select_node",r)):(r=e.makeArray(a.jstree("get_children_dom",i.node)),a.jstree("deselect_node",r))}}).jstree({types:{default:{icon:"fa fa-folder m--font-warning"},file:{icon:"fa fa-file  m--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},plugins:["checkbox","types"]})},getFeatureValues:function(){var t=[];return a.find(".jstree-node").each(function(){var n=e(this),i=JSON.parse(n.attr("data-feature"));i.inputType&&"CHECKBOX"!=i.inputType.name?t.push({name:i.name,value:n.attr("data-feature-value")}):t.push({name:i.name,value:a.jstree("is_checked",n)?"true":"false"})}),t},isValid:function(){return a.find(".feature-tree-textbox-invalid").length<=0}}}}(jQuery);!function(e){e.validator.addMethod("tenancyNameRegex",function(e,t,a){return a.test(e)},app.localize("TenantName_Regex_Description")),app.modals.CreateTenantModal=function(){var t,a=abp.services.app.tenant,n=null,i=new app.PasswordComplexityHelper;this.init=function(a){function r(){u.is(":checked")?(l.slideUp("fast"),f.removeAttr("required")):(l.slideDown("fast"),f.attr("required","required"))}var o=(t=a).getModal();(n=o.find("form[name=TenantInformationsForm]")).validate({rules:{TenancyName:{tenancyNameRegex:new RegExp(n.find("input[name=TenancyName]").attr("regex"))}}});var s=o.find("input[name=AdminPassword],input[name=AdminPasswordRepeat]"),d=s.closest(".form-group");i.setPasswordComplexityRules(s,window.passwordComplexitySetting),e("#CreateTenant_SetRandomPassword").change(function(){e(this).is(":checked")?(d.slideUp("fast"),s.removeAttr("required")):(d.slideDown("fast"),s.attr("required","required"))});var c=o.find("input[name=ConnectionString]"),p=c.closest(".form-group");e("#CreateTenant_UseHostDb").change(function(){e(this).is(":checked")?(p.slideUp("fast"),c.removeAttr("required")):(p.slideDown("fast"),c.attr("required","required"))}),o.find(".date-time-picker").datetimepicker({locale:abp.localization.currentLanguage.name,format:"L"});var l=o.find("input[name=SubscriptionEndDateUtc]").parent("div"),u=o.find("#CreateTenant_IsUnlimited"),f=o.find("input[name=SubscriptionEndDateUtc]");u.change(function(){r()});var m=o.find("#EditionId"),v=o.find("#CreateTenant_IsInTrialPeriod");m.change(function(){var t="True"===e("option:selected",this).attr("data-isfree"),a=e("option:selected",this).val();t?v.closest("div").slideUp("fast"):v.closest("div").slideDown("fast"),a<=0?o.find(".subscription-component").slideUp("fast"):o.find(".subscription-component").slideDown("fast")}),m.trigger("change"),r()},this.save=function(){if(n.valid()){var i=n.serializeFormToObject();e("#CreateTenant_IsUnlimited").is(":visible")&&!e("#CreateTenant_IsUnlimited").is(":checked")?i.SubscriptionEndDateUtc=moment(e(".date-time-picker").datadatetimepicker("getDate")).format("YYYY-MM-DDTHH:mm:ss")+"Z":i.SubscriptionEndDateUtc=null,i.SetRandomPassword&&(i.Password=null),i.UseHostDb&&(i.ConnectionString=null),t.setBusy(!0),a.createTenant(i).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),t.close(),abp.event.trigger("app.createTenantModalSaved")}).always(function(){t.setBusy(!1)})}}}}(jQuery);var EditTenantModal=function(e){app.modals.EditTenantModal=function(){var t,a=abp.services.app.tenant,n=null;this.init=function(a){function i(){s.is(":checked")?o.slideUp("fast"):o.slideDown("fast")}var r=(t=a).getModal();(n=r.find("form[name=TenantInformationsForm]")).validate(),r.find(".date-time-picker").datetimepicker({locale:abp.localization.currentLanguage.name,format:"L"});var o=r.find("input[name=SubscriptionEndDateUtc]").parent("div"),s=r.find("#CreateTenant_IsUnlimited");s.change(function(){i()});var d=r.find("#EditionId"),c=r.find("#EditTenant_IsInTrialPeriod");d.change(function(){var t="True"===e("option:selected",this).attr("data-isfree"),a=e("option:selected",this).val();t?c.closest("div").slideUp("fast"):c.closest("div").slideDown("fast"),a<=0?r.find(".subscription-component").slideUp("fast"):r.find(".subscription-component").slideDown("fast")}),d.trigger("change"),i()},this.save=function(){if(n.valid()){var i=n.serializeFormToObject();e("#CreateTenant_IsUnlimited").is(":visible")&&!e("#CreateTenant_IsUnlimited").is(":checked")?i.SubscriptionEndDateUtc=moment(e(".date-time-picker").datetimepicker("getDate")).format("YYYY-MM-DDTHH:mm:ss")+"Z":i.SubscriptionEndDateUtc=null,t.setBusy(!0),a.updateTenant(i).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),t.close(),abp.event.trigger("app.editTenantModalSaved")}).always(function(){t.setBusy(!1)})}}}}(jQuery);app.modals.TenantFeaturesModal=function(){var e,t,a=abp.services.app.tenant;this.init=function(n){e=n,(t=new FeaturesTree).init(e.getModal().find(".feature-tree")),e.getModal().find("[data-toggle=tooltip]").tooltip(),e.getModal().find(".reset-features-button").click(function(){e.setBusy(!0),a.resetTenantSpecificFeatures({id:e.getArgs().id}).done(function(){abp.notify.info(app.localize("ResetSuccessfully")),e.getModal().on("hidden.bs.modal",function(t){e.reopen()}),e.close()}).always(function(){e.setBusy(!1)})})},this.save=function(){t.isValid()?(e.setBusy(!0),a.updateTenantFeatures({id:e.getArgs().id,featureValues:t.getFeatureValues()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),e.close()}).always(function(){e.setBusy(!1)})):abp.message.warn(app.localize("InvalidFeaturesWarning"))}},$(function(){function e(){h.ajax.reload()}var t=abp.services.app.tenant,a=$("#TenantsTable"),n=$("#TenantsTableFilter"),i=$("#TenantsFormFilter"),r=$("#TenantsTable_SubscriptionEndDateRangeActive"),o=i.find("input[name='SubscriptionEndDateRange']"),s=$("#TenantsTable_CreationDateRangeActive"),d=i.find("input[name='CreationDateRange']"),c=i.find("button[name='RefreshButton']"),p=i.find("#EditionDropdown"),l={create:abp.auth.hasPermission("Pages.Tenants.Create"),edit:abp.auth.hasPermission("Pages.Tenants.Edit"),changeFeatures:abp.auth.hasPermission("Pages.Tenants.ChangeFeatures"),impersonation:abp.auth.hasPermission("Pages.Tenants.Impersonation"),delete:abp.auth.hasPermission("Pages.Tenants.Delete")},u={creationDateStart:$.url("?creationDateStart"),creationDateEnd:$.url("?creationDateEnd"),subscriptionEndDateStart:$.url("?subscriptionEndDateStart"),subscriptionEndDateEnd:$.url("?subscriptionEndDateEnd")},f={startDate:u.subscriptionEndDateStart?moment(u.subscriptionEndDateStart):moment().startOf("day"),endDate:u.subscriptionEndDateEnd?moment(u.subscriptionEndDateEnd):moment().add(30,"days").endOf("day")},m={startDate:u.creationDateStart?moment(u.creationDateStart):moment().add(-7,"days").startOf("day"),endDate:u.creationDateEnd?moment(u.creationDateEnd):moment().endOf("day")};o.daterangepicker($.extend(!0,app.createDateRangePickerOptions({allowFutureDate:!0}),f),function(e,t,a){f.startDate=e,f.endDate=t}),d.daterangepicker($.extend(!0,app.createDateRangePickerOptions(),m),function(e,t,a){m.startDate=e,m.endDate=t});var v=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/CreateModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_CreateModal.js",modalClass:"CreateTenantModal"}),g=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_EditModal.js",modalClass:"EditTenantModal"}),b=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/FeaturesModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_FeaturesModal.js",modalClass:"TenantFeaturesModal"}),T=app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers}),h=a.DataTable({paging:!0,serverSide:!0,processing:!0,listAction:{ajaxFunction:t.getTenants,inputFilter:function(){return function(){var e=p.find(":selected").val(),t={filter:n.val(),editionId:e,editionIdSpecified:"-1"!==e};return s.prop("checked")&&(t.creationDateStart=m.startDate,t.creationDateEnd=m.endDate),r.prop("checked")&&(t.subscriptionEndDateStart=f.startDate,t.subscriptionEndDateEnd=f.endDate),t}()}},columnDefs:[{targets:0,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{cssClass:"btn btn-xs btn-primary blue",text:'<i class="fa fa-cog"></i> '+app.localize("Actions")+' <span class="caret"></span>',items:[{text:app.localize("LoginAsThisTenant"),visible:function(){return l.impersonation},action:function(e){T.open({extraFilters:{tenantId:e.record.id},title:app.localize("SelectAUser")},function(t){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:e.record.id,userId:parseInt(t.value)}),success:function(){app.supportsTenancyNameInUrl||abp.multiTenancy.setTenantIdCookie(e.record.id)}})})}},{text:app.localize("Edit"),visible:function(){return l.edit},action:function(e){g.open({id:e.record.id})}},{text:app.localize("Features"),visible:function(){return l.changeFeatures},action:function(e){b.open({id:e.record.id})}},{text:app.localize("Delete"),visible:function(){return l.delete},action:function(a){!function(a){abp.message.confirm(app.localize("TenantDeleteWarningMessage",a.tenancyName),function(n){n&&t.deleteTenant({id:a.id}).done(function(){e(),abp.notify.success(app.localize("SuccessfullyDeleted"))})})}(a.record)}},{text:app.localize("Unlock"),action:function(e){t.unlockTenantAdmin({id:e.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTenandAdmin",e.record.name))})}}]}},{targets:1,data:"tenancyName"},{targets:2,data:"name"},{targets:3,data:"editionDisplayName"},{targets:4,data:"subscriptionEndDateUtc",render:function(e){return e?moment(e).format("L"):""}},{targets:5,data:"isActive",render:function(e){return e?'<span class="label label-success">'+app.localize("Yes")+"</span>":'<span class="label label-default">'+app.localize("No")+"</span>"}},{targets:6,data:"creationTime",render:function(e){return moment(e).format("L")}}]});$("#CreateNewTenantButton").click(function(){v.open()}),$("#GetTenantsButton").click(function(t){t.preventDefault(),e()}),abp.event.on("app.editTenantModalSaved",function(){e()}),abp.event.on("app.createTenantModalSaved",function(){e()}),r.change(function(){o.prop("disabled",!$(this).prop("checked"))}),u.subscriptionEndDateStart||u.subscriptionEndDateEnd?r.prop("checked",!0):o.prop("disabled",!0),s.change(function(){d.prop("disabled",!$(this).prop("checked"))}),u.creationDateStart||u.creationDateEnd?s.prop("checked",!0):d.prop("disabled",!0),c.click(function(t){t.preventDefault(),e()}),n.focus()});